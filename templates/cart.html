{% extends "base.html" %}

{% block content %}
<div class="container">
    <h1 style="margin-bottom: 20px;">Your Shopping Cart</h1>

    {% if cart_items %}
    <div class="cart-container" style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px; margin: 30px 0;">
        <div class="cart-items" style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);">
            {% for item_id, item in cart_items.items() %}
            <div class="cart-item" data-product-id="{{ item_id }}" style="display: grid; grid-template-columns: 80px 2fr 1fr 1fr 100px; gap: 20px; align-items: center; padding: 20px 0; border-bottom: 1px solid #eee;">
                <div class="item-image">
                    <img src="{{ url_for('static', filename='images/' + item.image) }}" alt="{{ item.name }}" style="width: 100%; border-radius: 4px;">
                </div>
                <div class="item-details">
                    <h3 style="margin-bottom: 5px;">{{ item.name }}</h3>
                    <p class="item-price" style="color: #007bff; font-weight: 600;">₹{{ "%.2f"|format(item.price) }}</p>
                </div>
                <div class="item-quantity" style="display: flex; align-items: center; justify-content: center;">
                    <button class="quantity-btn decrease" data-action="decrease" style="background: #f1f3f5; border: none; width: 30px; height: 30px; border-radius: 4px; cursor: pointer; font-weight: bold;">-</button>
                    <span class="quantity" style="margin: 0 10px; font-weight: 500;">{{ item.quantity }}</span>
                    <button class="quantity-btn increase" data-action="increase" style="background: #f1f3f5; border: none; width: 30px; height: 30px; border-radius: 4px; cursor: pointer; font-weight: bold;">+</button>
                </div>
                <div class="item-total" style="font-weight: 600; text-align: center;">
                    ₹{{ "%.2f"|format(item.price * item.quantity) }}
                </div>
                <div class="item-actions" style="text-align: center;">
                    <button class="remove-btn" data-action="remove" style="background: none; border: none; color: #dc3545; cursor: pointer; font-weight: 500;">Remove</button>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="cart-summary" style="background: white; border-radius: 8px; padding: 25px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); position: sticky; top: 100px;">
            <h3 style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee;">Order Summary</h3>
            <div class="summary-item" style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                <span>Subtotal:</span>
                <span>₹{{ "%.2f"|format(cart_items.values()|sum(attribute='price') * cart_items.values()|sum(attribute='quantity')) }}</span>
            </div>
            <div class="summary-item" style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                <span>Shipping:</span>
                <span>Free</span>
            </div>
            <div class="summary-item total" style="display: flex; justify-content: space-between; font-size: 1.2rem; font-weight: 700; padding-top: 15px; border-top: 1px solid #eee; margin-top: 10px;">
                <span>Total:</span>
                <span>₹{{ "%.2f"|format(cart_items.values()|sum(attribute='price') * cart_items.values()|sum(attribute='quantity')) }}</span>
            </div>
            <a href="{{ url_for('checkout') }}" class="btn btn-primary btn-large" style="padding: 15px 40px; font-size: 1.1rem; width: 100%; margin-top: 20px;">Proceed to Checkout</a>
        </div>
    </div>
    {% else %}
    <div class="empty-cart" style="text-align: center; padding: 60px 0;">
        <i class="fas fa-shopping-cart" style="font-size: 5rem; color: #ddd; margin-bottom: 20px;"></i>
        <h2>Your cart is empty</h2>
        <p style="color: #666; margin-bottom: 30px;">Looks like you haven't added anything to your cart yet.</p>
        <a href="{{ url_for('index') }}" class="btn btn-primary">Continue Shopping</a>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const quantityButtons = document.querySelectorAll('.quantity-btn');
    quantityButtons.forEach(button => {
        button.addEventListener('click', function() {
            const action = this.dataset.action;
            const cartItem = this.closest('.cart-item');
            const quantityElement = cartItem.querySelector('.quantity');
            let quantity = parseInt(quantityElement.textContent);

            if (action === 'increase') {
                quantity++;
            } else if (action === 'decrease' && quantity > 1) {
                quantity--;
            }

            quantityElement.textContent = quantity;

            const priceElement = cartItem.querySelector('.item-price');
            const priceText = priceElement.textContent.replace('₹', '').replace(',', '');
            const price = parseFloat(priceText);
            const totalElement = cartItem.querySelector('.item-total');
            totalElement.textContent = '₹' + (price * quantity).toFixed(2);

            updateCartSummary();
        });
    });

    const removeButtons = document.querySelectorAll('.remove-btn');
    removeButtons.forEach(button => {
        button.addEventListener('click', function() {
            const cartItem = this.closest('.cart-item');
            const productId = cartItem.dataset.productId;
            cartItem.remove();
            updateCartSummary();
            fetch('/update_cart', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `product_id=${productId}&action=remove`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (document.querySelectorAll('.cart-item').length === 0) {
                         window.location.reload();
                    }
                } else {
                     console.error("Failed to remove item on server");
                }
            })
            .catch(error => {
                 console.error('Error:', error);
            });
        });
    });

    function updateCartSummary() {
        const cartItems = document.querySelectorAll('.cart-item');
        let subtotal = 0;

        cartItems.forEach(item => {
            const totalElement = item.querySelector('.item-total');
            const totalText = totalElement.textContent.replace('₹', '').replace(',', '');
            const total = parseFloat(totalText);
            if (!isNaN(total)) {
                subtotal += total;
            }
        });

        const subtotalElements = document.querySelectorAll('.summary-item span:last-child');
        subtotalElements.forEach(el => {
             el.textContent = '₹' + subtotal.toFixed(2);
        });
    }

});
</script>
{% endblock %}